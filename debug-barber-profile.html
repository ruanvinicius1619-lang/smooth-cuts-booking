<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Painel do Barbeiro no Perfil</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .log {
            margin: 5px 0;
            padding: 8px;
            border-radius: 3px;
        }
        .step {
            background-color: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Painel do Barbeiro no Perfil</h1>
        <p>Esta p√°gina ajuda a diagnosticar por que a aba "Painel do Barbeiro" n√£o est√° aparecendo no perfil.</p>
        
        <div class="test-section">
            <h3>üß™ Diagn√≥sticos Dispon√≠veis</h3>
            <button onclick="checkSupabaseSession()">1. Verificar Sess√£o Supabase</button>
            <button onclick="testIsBarberFunction()">2. Testar Fun√ß√£o isBarber</button>
            <button onclick="checkProfilePage()">3. Verificar P√°gina de Perfil</button>
            <button onclick="simulateBarberLogin()">4. Simular Login Barbeiro</button>
            <button onclick="checkLocalStorage()">5. Verificar LocalStorage</button>
            <button onclick="runFullDiagnostic()">üöÄ Executar Diagn√≥stico Completo</button>
            <button onclick="clearLogs()">Limpar Logs</button>
        </div>
        
        <div class="test-section">
            <h3>üìã Instru√ß√µes de Teste</h3>
            <div class="step">
                <strong>Passo 1:</strong> Fa√ßa login com barbeiro@smoothcuts.com / 123456 em <a href="/auth" target="_blank">http://localhost:8080/auth</a>
            </div>
            <div class="step">
                <strong>Passo 2:</strong> V√° para o perfil em <a href="/profile" target="_blank">http://localhost:8080/profile</a>
            </div>
            <div class="step">
                <strong>Passo 3:</strong> Execute o diagn√≥stico completo nesta p√°gina
            </div>
            <div class="step">
                <strong>Passo 4:</strong> Verifique se a aba "Painel do Barbeiro" aparece
            </div>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        // Configura√ß√£o dos barbeiros
        const BARBER_CONFIG = {
            authorizedBarbers: [
                {
                    id: 'default-barber',
                    email: 'barbeiro@mateusbarber.com',
                    name: 'Barbeiro Padr√£o',
                    permissions: ['view_appointments']
                },
                {
                    id: 'smoothcuts-barber',
                    email: 'barbeiro@smoothcuts.com',
                    name: 'Barbeiro SmoothCuts',
                    permissions: ['view_appointments']
                },
                {
                    id: 'joao-barber',
                    email: 'joao@mateusbarber.com',
                    name: 'Jo√£o',
                    permissions: ['view_appointments']
                },
                {
                    id: 'pedro-barber',
                    email: 'pedro@mateusbarber.com',
                    name: 'Pedro',
                    permissions: ['view_appointments']
                }
            ]
        };

        const isBarber = (email) => {
            if (!email) return false;
            return BARBER_CONFIG.authorizedBarbers.some(barber => barber.email === email);
        };

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function checkSupabaseSession() {
            log('=== VERIFICANDO SESS√ÉO SUPABASE ===', 'info');
            
            // Verificar todas as chaves do localStorage relacionadas ao Supabase
            const supabaseKeys = Object.keys(localStorage).filter(key => 
                key.includes('supabase') || key.includes('auth')
            );
            
            if (supabaseKeys.length === 0) {
                log('‚ùå Nenhuma chave do Supabase encontrada no localStorage', 'error');
                log('Isso indica que o usu√°rio n√£o est√° logado', 'warning');
                return;
            }
            
            log(`‚úÖ Encontradas ${supabaseKeys.length} chaves do Supabase:`, 'success');
            supabaseKeys.forEach(key => {
                log(`- ${key}`);
                try {
                    const value = localStorage.getItem(key);
                    if (value) {
                        const parsed = JSON.parse(value);
                        if (parsed.user && parsed.user.email) {
                            log(`  Email do usu√°rio: ${parsed.user.email}`, 'info');
                            
                            // Testar se √© barbeiro
                            const isBarbeiro = isBarber(parsed.user.email);
                            if (isBarbeiro) {
                                log(`  ‚úÖ ${parsed.user.email} √â um barbeiro autorizado!`, 'success');
                            } else {
                                log(`  ‚ùå ${parsed.user.email} N√ÉO √© um barbeiro autorizado`, 'error');
                            }
                        }
                    }
                } catch (e) {
                    log(`  Erro ao fazer parse: ${e.message}`, 'warning');
                }
            });
        }

        function testIsBarberFunction() {
            log('=== TESTANDO FUN√á√ÉO isBarber ===', 'info');
            
            const testEmail = 'barbeiro@smoothcuts.com';
            const result = isBarber(testEmail);
            
            log(`Testando email: ${testEmail}`);
            log(`Resultado isBarber: ${result}`);
            
            if (result) {
                log('‚úÖ Fun√ß√£o isBarber est√° funcionando corretamente!', 'success');
            } else {
                log('‚ùå Fun√ß√£o isBarber N√ÉO est√° reconhecendo o barbeiro!', 'error');
            }
            
            // Mostrar lista de barbeiros autorizados
            log('Lista de barbeiros autorizados:');
            BARBER_CONFIG.authorizedBarbers.forEach(barber => {
                log(`- ${barber.email} (${barber.name})`);
            });
        }

        function checkProfilePage() {
            log('=== VERIFICANDO P√ÅGINA DE PERFIL ===', 'info');
            
            // Verificar se estamos na p√°gina de perfil
            if (window.location.pathname === '/profile') {
                log('‚úÖ Estamos na p√°gina de perfil', 'success');
                
                // Verificar se as abas existem
                const tabs = document.querySelectorAll('[role="tab"]');
                log(`Encontradas ${tabs.length} abas:`);
                
                tabs.forEach((tab, index) => {
                    const text = tab.textContent.trim();
                    log(`  Aba ${index + 1}: ${text}`);
                    
                    if (text.includes('Painel do Barbeiro')) {
                        log('  ‚úÖ Aba "Painel do Barbeiro" encontrada!', 'success');
                    }
                });
                
                if (!Array.from(tabs).some(tab => tab.textContent.includes('Painel do Barbeiro'))) {
                    log('‚ùå Aba "Painel do Barbeiro" N√ÉO encontrada!', 'error');
                }
                
            } else {
                log('‚ö†Ô∏è N√£o estamos na p√°gina de perfil', 'warning');
                log(`P√°gina atual: ${window.location.pathname}`);
                log('Abra a p√°gina de perfil para verificar as abas');
            }
        }

        function simulateBarberLogin() {
            log('=== SIMULANDO LOGIN DO BARBEIRO ===', 'info');
            
            const mockSession = {
                user: {
                    id: 'mock-barber-id',
                    email: 'barbeiro@smoothcuts.com',
                    user_metadata: {
                        full_name: 'Barbeiro SmoothCuts'
                    }
                }
            };
            
            log('Simulando sess√£o do barbeiro:');
            log(`<pre>${JSON.stringify(mockSession, null, 2)}</pre>`);
            
            // Testar se a aba deveria aparecer
            const shouldShowTab = isBarber(mockSession.user.email);
            log(`isBarber(${mockSession.user.email}): ${shouldShowTab}`);
            
            if (shouldShowTab) {
                log('‚úÖ Com esta sess√£o, a aba "Painel do Barbeiro" DEVERIA aparecer!', 'success');
            } else {
                log('‚ùå Com esta sess√£o, a aba "Painel do Barbeiro" N√ÉO apareceria!', 'error');
            }
        }

        function checkLocalStorage() {
            log('=== VERIFICANDO LOCALSTORAGE ===', 'info');
            
            const allKeys = Object.keys(localStorage);
            log(`Total de chaves no localStorage: ${allKeys.length}`);
            
            // Agrupar chaves por tipo
            const supabaseKeys = allKeys.filter(k => k.includes('supabase'));
            const authKeys = allKeys.filter(k => k.includes('auth'));
            const otherKeys = allKeys.filter(k => !k.includes('supabase') && !k.includes('auth'));
            
            if (supabaseKeys.length > 0) {
                log(`Chaves do Supabase (${supabaseKeys.length}):`);
                supabaseKeys.forEach(key => log(`  - ${key}`));
            }
            
            if (authKeys.length > 0) {
                log(`Chaves de Auth (${authKeys.length}):`);
                authKeys.forEach(key => log(`  - ${key}`));
            }
            
            if (otherKeys.length > 0) {
                log(`Outras chaves (${otherKeys.length}):`);
                otherKeys.forEach(key => log(`  - ${key}`));
            }
            
            // Verificar especificamente a chave de sess√£o do Supabase
            const sessionKey = supabaseKeys.find(k => k.includes('auth.token') || k.includes('session'));
            if (sessionKey) {
                log(`Verificando chave de sess√£o: ${sessionKey}`);
                try {
                    const sessionData = JSON.parse(localStorage.getItem(sessionKey));
                    if (sessionData && sessionData.user) {
                        log(`Email na sess√£o: ${sessionData.user.email}`);
                        log(`ID do usu√°rio: ${sessionData.user.id}`);
                    }
                } catch (e) {
                    log(`Erro ao ler sess√£o: ${e.message}`, 'error');
                }
            }
        }

        function runFullDiagnostic() {
            log('üöÄ EXECUTANDO DIAGN√ìSTICO COMPLETO', 'info');
            log('='.repeat(50));
            
            checkSupabaseSession();
            log('');
            testIsBarberFunction();
            log('');
            checkProfilePage();
            log('');
            checkLocalStorage();
            log('');
            
            log('='.repeat(50));
            log('‚úÖ DIAGN√ìSTICO COMPLETO FINALIZADO', 'success');
            
            // Resumo final
            log('üìä RESUMO:', 'info');
            log('1. Verifique se h√° uma sess√£o ativa do Supabase');
            log('2. Confirme que o email barbeiro@smoothcuts.com est√° na sess√£o');
            log('3. Verifique se a fun√ß√£o isBarber retorna true para este email');
            log('4. Se tudo estiver correto, a aba deveria aparecer na p√°gina de perfil');
        }

        // Auto-executar diagn√≥stico ao carregar
        window.onload = function() {
            log('üîç P√°gina de debug carregada', 'info');
            log('Execute o diagn√≥stico completo para verificar o problema');
        };
    </script>
</body>
</html>