<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar Agendamentos Problem√°ticos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .danger {
            background-color: #dc3545;
        }
        .danger:hover {
            background-color: #c82333;
        }
        .success {
            background-color: #28a745;
        }
        .success:hover {
            background-color: #218838;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .appointment {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .problematic {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpar Agendamentos Problem√°ticos</h1>
        <p>Esta ferramenta identifica e remove agendamentos com UUIDs problem√°ticos que causam "Nome n√£o configurado".</p>
        
        <div>
            <button class="button" onclick="checkAppointments()">üîç Verificar Agendamentos</button>
            <button class="button danger" onclick="removeProblematicAppointments()">üóëÔ∏è Remover Problem√°ticos</button>
            <button class="button success" onclick="showOnlyRealUsers()">‚úÖ Mostrar Apenas Usu√°rios Reais</button>
            <button class="button danger" onclick="clearAllAppointments()">üö® Limpar Todos</button>
        </div>
        
        <div id="log" class="log"></div>
        <div id="appointments"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function isValidUUID(str) {
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }

        function isProblematicUUID(userId) {
            // Lista de UUIDs problem√°ticos conhecidos
            const problematicUUIDs = [
                '3173d3c1-4c20-4d8a-a75a-9d6635932ca9',
                '12345678-1234-1234-1234-123456789abc',
                'test-uuid-1',
                'test-uuid-2',
                'test-uuid-3',
                'test-uuid-4',
                'test-uuid-5'
            ];
            
            return problematicUUIDs.includes(userId) || 
                   (isValidUUID(userId) && userId.startsWith('3173d3c1'));
        }

        function checkAppointments() {
            log('üîç Verificando agendamentos no localStorage...');
            
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            log(`üìä Total de agendamentos encontrados: ${appointments.length}`);
            
            const appointmentsDiv = document.getElementById('appointments');
            appointmentsDiv.innerHTML = '<h3>üìã Agendamentos Encontrados:</h3>';
            
            let problematicCount = 0;
            let realCount = 0;
            
            appointments.forEach((appointment, index) => {
                const isProblematic = isProblematicUUID(appointment.user_id);
                const div = document.createElement('div');
                div.className = `appointment ${isProblematic ? 'problematic' : ''}`;
                
                div.innerHTML = `
                    <strong>Agendamento ${index + 1}:</strong><br>
                    üìÖ Data: ${appointment.date}<br>
                    ‚è∞ Hora: ${appointment.time}<br>
                    üë§ User ID: ${appointment.user_id}<br>
                    üìß Email: ${appointment.user_email || 'N√£o informado'}<br>
                    üìû Telefone: ${appointment.user_phone || 'N√£o informado'}<br>
                    üíá Servi√ßo: ${appointment.service}<br>
                    üë®‚Äçüíº Barbeiro: ${appointment.barber}<br>
                    ${isProblematic ? '‚ö†Ô∏è <strong>PROBLEM√ÅTICO</strong>' : '‚úÖ <strong>REAL</strong>'}
                `;
                
                appointmentsDiv.appendChild(div);
                
                if (isProblematic) {
                    problematicCount++;
                } else {
                    realCount++;
                }
            });
            
            log(`‚ö†Ô∏è Agendamentos problem√°ticos: ${problematicCount}`);
            log(`‚úÖ Agendamentos reais: ${realCount}`);
        }

        function removeProblematicAppointments() {
            log('üóëÔ∏è Removendo agendamentos problem√°ticos...');
            
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            const originalCount = appointments.length;
            
            const cleanAppointments = appointments.filter(appointment => {
                const isProblematic = isProblematicUUID(appointment.user_id);
                if (isProblematic) {
                    log(`üóëÔ∏è Removendo: ${appointment.user_id} - ${appointment.date} ${appointment.time}`);
                }
                return !isProblematic;
            });
            
            localStorage.setItem('appointments', JSON.stringify(cleanAppointments));
            
            const removedCount = originalCount - cleanAppointments.length;
            log(`‚úÖ Removidos ${removedCount} agendamentos problem√°ticos`);
            log(`üìä Agendamentos restantes: ${cleanAppointments.length}`);
            
            // Atualizar a visualiza√ß√£o
            checkAppointments();
        }

        function showOnlyRealUsers() {
            log('‚úÖ Configurando para mostrar apenas usu√°rios reais...');
            
            // Primeiro, limpar agendamentos problem√°ticos
            removeProblematicAppointments();
            
            // Verificar se h√° agendamentos reais restantes
            const appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            
            if (appointments.length === 0) {
                log('‚ÑπÔ∏è Nenhum agendamento real encontrado.');
                log('üí° Sugest√£o: Crie novos agendamentos com usu√°rios reais.');
            } else {
                log(`‚úÖ ${appointments.length} agendamentos reais mantidos.`);
                log('üîÑ Recarregue a p√°gina do Painel do Barbeiro para ver as mudan√ßas.');
            }
        }

        function clearAllAppointments() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja remover TODOS os agendamentos? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem('appointments');
                log('üö® Todos os agendamentos foram removidos do localStorage.');
                document.getElementById('appointments').innerHTML = '';
            }
        }

        // Verificar automaticamente ao carregar a p√°gina
        window.onload = function() {
            log('üöÄ Ferramenta de limpeza carregada.');
            log('üí° Clique em "Verificar Agendamentos" para come√ßar.');
        };
    </script>
</body>
</html>