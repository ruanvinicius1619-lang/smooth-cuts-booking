<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Aba do Barbeiro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        .step {
            background-color: #e9ecef;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            border-radius: 5px;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin: 20px 0;
        }
        .credentials {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin: 10px 0;
        }
        .iframe-container {
            border: 2px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .log {
            background-color: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Final - Aba do Barbeiro</h1>
        <p>Este √© o teste definitivo para verificar se a aba "Painel do Barbeiro" aparece na p√°gina de perfil.</p>
        
        <div class="instructions">
            <h3>üìã Instru√ß√µes do Teste</h3>
            <ol>
                <li><strong>Fa√ßa login</strong> com as credenciais do barbeiro</li>
                <li><strong>V√° para a p√°gina de perfil</strong> usando o bot√£o abaixo</li>
                <li><strong>Verifique</strong> se a aba "Painel do Barbeiro" aparece</li>
                <li><strong>Execute os testes autom√°ticos</strong> para diagn√≥stico completo</li>
            </ol>
        </div>
        
        <div class="credentials">
            <h4>üîê Credenciais do Barbeiro</h4>
            <strong>Email:</strong> <span class="highlight">barbeiro@smoothcuts.com</span><br>
            <strong>Senha:</strong> <span class="highlight">123456</span>
        </div>
        
        <div class="test-section">
            <h3>üöÄ A√ß√µes R√°pidas</h3>
            <button onclick="openAuth()">üîê Abrir P√°gina de Login</button>
            <button onclick="openProfile()">üë§ Abrir P√°gina de Perfil</button>
            <button onclick="runDiagnostic()" class="success">üîç Executar Diagn√≥stico</button>
        </div>
        
        <div class="test-section">
            <h3>üß™ Testes Autom√°ticos</h3>
            <button onclick="testSupabaseConnection()">üîó Testar Conex√£o Supabase</button>
            <button onclick="testIsBarberFunction()">‚öôÔ∏è Testar Fun√ß√£o isBarber</button>
            <button onclick="testUserSession()">üë§ Testar Sess√£o do Usu√°rio</button>
            <button onclick="testProfilePageElements()">üéØ Testar Elementos da P√°gina</button>
        </div>
        
        <div id="results"></div>
        
        <div class="test-section">
            <h3>üñ•Ô∏è P√°gina de Perfil (Iframe)</h3>
            <p>A p√°gina de perfil ser√° carregada abaixo. <strong>Certifique-se de estar logado primeiro!</strong></p>
            <div class="iframe-container">
                <iframe id="profileFrame" src="/profile" title="P√°gina de Perfil"></iframe>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Configura√ß√£o do Supabase
        const supabaseUrl = 'https://jheywkeofcttgdgquawm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZXl3a2VvZmN0dGdkZ3F1YXdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjc2MjAsImV4cCI6MjA3MDcwMzYyMH0.6vOdNR1-h0ac_STZFp4ITuI8p5fjEVlnZkUT2hSxKX0';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // Configura√ß√£o dos barbeiros
        const BARBER_CONFIG = {
            authorizedBarbers: [
                {
                    id: 'default-barber',
                    email: 'barbeiro@mateusbarber.com',
                    name: 'Barbeiro Padr√£o',
                    permissions: ['view_appointments']
                },
                {
                    id: 'smoothcuts-barber',
                    email: 'barbeiro@smoothcuts.com',
                    name: 'Barbeiro SmoothCuts',
                    permissions: ['view_appointments']
                },
                {
                    id: 'joao-barber',
                    email: 'joao@mateusbarber.com',
                    name: 'Jo√£o',
                    permissions: ['view_appointments']
                },
                {
                    id: 'pedro-barber',
                    email: 'pedro@mateusbarber.com',
                    name: 'Pedro',
                    permissions: ['view_appointments']
                }
            ]
        };

        const isBarber = (email) => {
            if (!email) return false;
            return BARBER_CONFIG.authorizedBarbers.some(barber => barber.email === email);
        };

        function addResult(title, message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <div class="log">${message}</div>
                <small>Executado em: ${new Date().toLocaleString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function openAuth() {
            window.open('/auth', '_blank');
            addResult('üîê P√°gina de Login', 'P√°gina de login aberta em nova aba', 'info');
        }

        function openProfile() {
            window.open('/profile', '_blank');
            addResult('üë§ P√°gina de Perfil', 'P√°gina de perfil aberta em nova aba', 'info');
        }

        async function testSupabaseConnection() {
            addResult('üîó Testando Conex√£o Supabase', 'Iniciando teste...', 'info');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    addResult('‚ùå Erro na Conex√£o', `Erro: ${error.message}`, 'error');
                    return false;
                }
                
                addResult('‚úÖ Conex√£o Supabase', 'Conex√£o estabelecida com sucesso', 'success');
                return true;
            } catch (error) {
                addResult('‚ùå Erro na Conex√£o', `Erro: ${error.message}`, 'error');
                return false;
            }
        }

        function testIsBarberFunction() {
            addResult('‚öôÔ∏è Testando Fun√ß√£o isBarber', 'Iniciando teste...', 'info');
            
            const testCases = [
                { email: 'barbeiro@smoothcuts.com', expected: true },
                { email: 'barbeiro@mateusbarber.com', expected: true },
                { email: 'joao@mateusbarber.com', expected: true },
                { email: 'pedro@mateusbarber.com', expected: true },
                { email: 'usuario@normal.com', expected: false },
                { email: null, expected: false },
                { email: '', expected: false }
            ];
            
            let results = [];
            let allPassed = true;
            
            testCases.forEach(testCase => {
                const result = isBarber(testCase.email);
                const passed = result === testCase.expected;
                
                if (!passed) allPassed = false;
                
                results.push(`${passed ? '‚úÖ' : '‚ùå'} ${testCase.email || 'null'} ‚Üí ${result} (esperado: ${testCase.expected})`);
            });
            
            const message = results.join('<br>');
            addResult(
                allPassed ? '‚úÖ Fun√ß√£o isBarber' : '‚ùå Fun√ß√£o isBarber', 
                message, 
                allPassed ? 'success' : 'error'
            );
            
            return allPassed;
        }

        async function testUserSession() {
            addResult('üë§ Testando Sess√£o do Usu√°rio', 'Verificando usu√°rio logado...', 'info');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    addResult('‚ùå Erro na Sess√£o', `Erro: ${error.message}`, 'error');
                    return false;
                }
                
                if (!session || !session.user) {
                    addResult('‚ö†Ô∏è Usu√°rio N√£o Logado', 'Nenhum usu√°rio est√° logado. Fa√ßa login primeiro!', 'warning');
                    return false;
                }
                
                const user = session.user;
                const isBarbeiro = isBarber(user.email);
                
                const message = `
                    Email: ${user.email}<br>
                    ID: ${user.id}<br>
                    √â Barbeiro: ${isBarbeiro ? 'SIM' : 'N√ÉO'}<br>
                    Email Confirmado: ${user.email_confirmed_at ? 'SIM' : 'N√ÉO'}
                `;
                
                addResult(
                    isBarbeiro ? '‚úÖ Usu√°rio Barbeiro Logado' : '‚ö†Ô∏è Usu√°rio Comum Logado',
                    message,
                    isBarbeiro ? 'success' : 'warning'
                );
                
                return isBarbeiro;
            } catch (error) {
                addResult('‚ùå Erro na Sess√£o', `Erro: ${error.message}`, 'error');
                return false;
            }
        }

        function testProfilePageElements() {
            addResult('üéØ Testando Elementos da P√°gina', 'Verificando iframe da p√°gina de perfil...', 'info');
            
            try {
                const iframe = document.getElementById('profileFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // Aguardar carregamento
                setTimeout(() => {
                    try {
                        // Verificar abas
                        const tabs = iframeDoc.querySelectorAll('[role="tab"]');
                        const tabsList = iframeDoc.querySelector('[role="tablist"]');
                        
                        let message = `Abas encontradas: ${tabs.length}<br>`;
                        
                        if (tabs.length > 0) {
                            tabs.forEach((tab, index) => {
                                const text = tab.textContent.trim();
                                message += `  Aba ${index + 1}: "${text}"<br>`;
                            });
                        }
                        
                        // Verificar aba espec√≠fica do barbeiro
                        const barberTab = iframeDoc.querySelector('[value="barber"]');
                        const barberTabTrigger = Array.from(tabs).find(tab => 
                            tab.textContent.includes('Painel do Barbeiro')
                        );
                        
                        if (barberTab || barberTabTrigger) {
                            message += '<br>‚úÖ Aba "Painel do Barbeiro" ENCONTRADA!';
                            addResult('‚úÖ Elementos da P√°gina', message, 'success');
                        } else {
                            message += '<br>‚ùå Aba "Painel do Barbeiro" N√ÉO encontrada!';
                            addResult('‚ùå Elementos da P√°gina', message, 'error');
                        }
                        
                    } catch (error) {
                        addResult('‚ùå Erro ao Acessar Iframe', `Erro: ${error.message}`, 'error');
                    }
                }, 2000);
                
            } catch (error) {
                addResult('‚ùå Erro nos Elementos', `Erro: ${error.message}`, 'error');
            }
        }

        async function runDiagnostic() {
            addResult('üîç Diagn√≥stico Completo', 'Iniciando diagn√≥stico completo...', 'info');
            
            const step1 = await testSupabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const step2 = testIsBarberFunction();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const step3 = await testUserSession();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testProfilePageElements();
            
            // Resultado final
            setTimeout(() => {
                const allPassed = step1 && step2 && step3;
                
                if (allPassed) {
                    addResult(
                        'üéâ Diagn√≥stico Completo', 
                        'Todos os testes passaram! A aba do barbeiro deveria estar vis√≠vel.', 
                        'success'
                    );
                } else {
                    addResult(
                        '‚ö†Ô∏è Diagn√≥stico Completo', 
                        'Alguns testes falharam. Verifique os resultados acima.', 
                        'warning'
                    );
                }
            }, 3000);
        }

        // Disponibilizar fun√ß√µes globalmente
        window.openAuth = openAuth;
        window.openProfile = openProfile;
        window.testSupabaseConnection = testSupabaseConnection;
        window.testIsBarberFunction = testIsBarberFunction;
        window.testUserSession = testUserSession;
        window.testProfilePageElements = testProfilePageElements;
        window.runDiagnostic = runDiagnostic;

        // Auto-executar ao carregar
        window.onload = function() {
            addResult('üöÄ Teste Final Carregado', 'P√°gina de teste carregada com sucesso', 'info');
        };
    </script>
</body>
</html>