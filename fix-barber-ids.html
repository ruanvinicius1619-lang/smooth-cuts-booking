<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correção de IDs de Barbeiros</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .log {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .log.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .log.success {
            background: #d4edda;
            color: #155724;
        }
        .log.warning {
            background: #fff3cd;
            color: #856404;
        }
        .log.error {
            background: #f8d7da;
            color: #721c24;
        }
        #logs {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Correção de IDs de Barbeiros</h1>
        
        <div style="margin-bottom: 20px;">
            <p><strong>Problema:</strong> Os IDs dos barbeiros estavam como strings simples ("pedro", "joao", "carlos") em vez de UUIDs válidos, causando erro no Supabase.</p>
            <p><strong>Solução:</strong> Atualizar para UUIDs válidos e corrigir agendamentos existentes.</p>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="button" onclick="checkCurrentData()">1. Verificar Dados Atuais</button>
            <button class="button" onclick="clearAndReloadBarbers()">2. Limpar e Recarregar Barbeiros</button>
            <button class="button" onclick="fixExistingBookings()">3. Corrigir Agendamentos Existentes</button>
            <button class="button danger" onclick="clearAllData()">4. Limpar Todos os Dados (Cuidado!)</button>
        </div>
        
        <div id="logs"></div>
    </div>

    <script>
        // Mapeamento de IDs antigos para novos UUIDs
        const ID_MAPPING = {
            'carlos': '550e8400-e29b-41d4-a716-446655440001',
            'joao': '550e8400-e29b-41d4-a716-446655440002', 
            'pedro': '550e8400-e29b-41d4-a716-446655440003'
        };
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function checkCurrentData() {
            log('=== VERIFICAÇÃO DE DADOS ATUAIS ===', 'info');
            
            // Verificar barbeiros no localStorage
            const adminBarbers = JSON.parse(localStorage.getItem('adminBarbers') || '[]');
            log(`📊 Barbeiros no localStorage: ${adminBarbers.length}`);
            
            adminBarbers.forEach((barber, index) => {
                const isOldId = Object.keys(ID_MAPPING).includes(barber.id);
                const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(barber.id);
                
                if (isOldId) {
                    log(`❌ Barbeiro ${index + 1}: ${barber.name} - ID antigo: ${barber.id}`, 'error');
                } else if (isUUID) {
                    log(`✅ Barbeiro ${index + 1}: ${barber.name} - UUID válido: ${barber.id}`, 'success');
                } else {
                    log(`⚠️ Barbeiro ${index + 1}: ${barber.name} - ID inválido: ${barber.id}`, 'warning');
                }
            });
            
            // Verificar agendamentos
            const userBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            log(`📅 Agendamentos no localStorage: ${userBookings.length}`);
            
            let problematicBookings = 0;
            userBookings.forEach((booking, index) => {
                const isOldId = Object.keys(ID_MAPPING).includes(booking.barber_id);
                if (isOldId) {
                    log(`❌ Agendamento ${index + 1}: barber_id antigo: ${booking.barber_id}`, 'error');
                    problematicBookings++;
                }
            });
            
            if (problematicBookings > 0) {
                log(`⚠️ Total de agendamentos com IDs problemáticos: ${problematicBookings}`, 'warning');
            } else {
                log('✅ Todos os agendamentos têm IDs válidos', 'success');
            }
        }
        
        function clearAndReloadBarbers() {
            log('=== LIMPANDO E RECARREGANDO BARBEIROS ===', 'info');
            
            // Remover barbeiros do localStorage para forçar recarregamento
            localStorage.removeItem('adminBarbers');
            log('🧹 Barbeiros removidos do localStorage', 'success');
            
            // Recarregar a página para que os novos UUIDs sejam carregados
            log('🔄 Recarregue a página da aplicação para carregar os novos UUIDs', 'info');
        }
        
        function fixExistingBookings() {
            log('=== CORRIGINDO AGENDAMENTOS EXISTENTES ===', 'info');
            
            const userBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            let fixedCount = 0;
            
            const updatedBookings = userBookings.map(booking => {
                if (ID_MAPPING[booking.barber_id]) {
                    const oldId = booking.barber_id;
                    const newId = ID_MAPPING[booking.barber_id];
                    booking.barber_id = newId;
                    log(`🔧 Agendamento ${booking.id}: ${oldId} → ${newId}`, 'success');
                    fixedCount++;
                }
                return booking;
            });
            
            if (fixedCount > 0) {
                localStorage.setItem('userBookings', JSON.stringify(updatedBookings));
                log(`✅ ${fixedCount} agendamentos corrigidos e salvos`, 'success');
            } else {
                log('ℹ️ Nenhum agendamento precisava de correção', 'info');
            }
        }
        
        function clearAllData() {
            if (!confirm('⚠️ ATENÇÃO: Isso irá remover TODOS os dados do localStorage (barbeiros, serviços, agendamentos). Tem certeza?')) {
                return;
            }
            
            log('=== LIMPEZA COMPLETA DE DADOS ===', 'warning');
            
            const keysToRemove = ['adminBarbers', 'adminServices', 'userBookings'];
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`🧹 Removido: ${key}`, 'warning');
            });
            
            log('✅ Limpeza completa realizada. Recarregue a aplicação.', 'success');
        }
        
        // Executar verificação inicial
        window.onload = function() {
            log('🔧 Ferramenta de Correção de IDs de Barbeiros carregada', 'info');
            log('👆 Clique em "1. Verificar Dados Atuais" para começar', 'info');
        };
    </script>
</body>
</html>